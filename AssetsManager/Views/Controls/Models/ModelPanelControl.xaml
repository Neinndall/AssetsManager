<UserControl x:Class="AssetsManager.Views.Controls.Models.ModelPanelControl"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:materialIcons="clr-namespace:Material.Icons.WPF;assembly=Material.Icons.WPF"
             mc:Ignorable="d" 
             d:DesignHeight="750" d:DesignWidth="300">

    <Border Background="{StaticResource SidebarBackground}" 
            BorderBrush="{StaticResource BorderColor}" 
            BorderThickness="1" 
            Margin="0,4,4,4">
        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <!-- NAVIGATION (Segmented Control) -->
            <Border Grid.Row="0" Margin="16,16,16,12" Background="{StaticResource SidebarBackground}" CornerRadius="8" Padding="4" BorderBrush="{StaticResource BorderColor}" BorderThickness="1">
                <UniformGrid Columns="5">
                    <RadioButton x:Name="TabModels" IsChecked="True" GroupName="MPT" Style="{StaticResource SegmentedRadioButtonStyle}" ToolTip="Models List">
                        <materialIcons:MaterialIcon Kind="CubeOutline" Width="18" Height="18"/>
                    </RadioButton>
                    <RadioButton x:Name="TabMeshes" GroupName="MPT" Style="{StaticResource SegmentedRadioButtonStyle}" ToolTip="Meshes &amp; Textures">
                        <materialIcons:MaterialIcon Kind="TextureBox" Width="18" Height="18"/>
                    </RadioButton>
                    <RadioButton x:Name="TabTransform" GroupName="MPT" Style="{StaticResource SegmentedRadioButtonStyle}" ToolTip="Position, Rotation &amp; Scale">
                        <materialIcons:MaterialIcon Kind="AxisArrow" Width="18" Height="18"/>
                    </RadioButton>
                    <RadioButton x:Name="TabAnimations" GroupName="MPT" Style="{StaticResource SegmentedRadioButtonStyle}" ToolTip="Animations">
                        <materialIcons:MaterialIcon Kind="AnimationPlay" Width="18" Height="18"/>
                    </RadioButton>
                    <RadioButton x:Name="TabStudio" GroupName="MPT" Style="{StaticResource SegmentedRadioButtonStyle}" ToolTip="Studio &amp; Render">
                        <materialIcons:MaterialIcon Kind="CameraIris" Width="18" Height="18"/>
                    </RadioButton>
                </UniformGrid>
            </Border>

            <!-- CONTENT AREA -->
            <Grid Grid.Row="1" Margin="16,0,16,0">
                <!-- MODELS -->
                <Grid x:Name="ModelsPanel">
                    <Grid.Style>
                        <Style TargetType="Grid">
                            <Setter Property="Visibility" Value="Collapsed"/>
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding IsChecked, ElementName=TabModels}" Value="True">
                                    <Setter Property="Visibility" Value="Visible"/>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </Grid.Style>
                    <ListBox x:Name="ModelsListBox" Style="{StaticResource SmoothScrollListBox}" SelectionChanged="ModelsListBox_SelectionChanged" Background="Transparent" BorderThickness="0">
                        <ListBox.ItemContainerStyle>
                            <Style TargetType="ListBoxItem">
                                <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                                <Setter Property="Background" Value="Transparent"/>
                                <Setter Property="Padding" Value="0"/>
                                <Setter Property="Margin" Value="0,0,0,8"/>
                                <Setter Property="Template">
                                    <Setter.Value>
                                        <ControlTemplate TargetType="ListBoxItem">
                                            <Grid x:Name="RootGrid">
                                                <!-- 1. Background / Selection Border -->
                                                <Border x:Name="SelectionBorder" Background="{StaticResource CardBackground}" CornerRadius="8" BorderBrush="{StaticResource BorderColor}" BorderThickness="1"/>
                                                
                                                <!-- 2. Content -->
                                                <Grid Margin="12,8">
                                                    <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="*"/>
                                                        <ColumnDefinition Width="Auto"/>
                                                    </Grid.ColumnDefinitions>
                                                    <ContentPresenter Grid.Column="0" />
                                                    <materialIcons:MaterialIcon x:Name="CheckIcon" Grid.Column="1" Kind="CheckCircle" Foreground="{StaticResource AccentBrush}" Width="18" Height="18" Margin="8,0,0,0" Visibility="Collapsed"/>
                                                </Grid>
                                            </Grid>
                                            <ControlTemplate.Triggers>
                                                <Trigger Property="IsSelected" Value="True">
                                                    <Setter TargetName="SelectionBorder" Property="BorderBrush" Value="{StaticResource AccentBrush}"/>
                                                    <Setter TargetName="SelectionBorder" Property="BorderThickness" Value="1.5"/>
                                                    <Setter TargetName="SelectionBorder" Property="Background" Value="{StaticResource HoverColor}"/>
                                                    <Setter TargetName="CheckIcon" Property="Visibility" Value="Visible"/>
                                                </Trigger>
                                                <Trigger Property="IsMouseOver" Value="True">
                                                    <Setter TargetName="SelectionBorder" Property="Background" Value="{StaticResource HoverColor}"/>
                                                </Trigger>
                                            </ControlTemplate.Triggers>
                                        </ControlTemplate>
                                    </Setter.Value>
                                </Setter>
                            </Style>
                        </ListBox.ItemContainerStyle>
                        <ListBox.ItemTemplate>
                            <DataTemplate>
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    
                                    <StackPanel Grid.Column="0" VerticalAlignment="Center">
                                        <TextBlock Text="{Binding Name}" Foreground="{StaticResource TextPrimary}" FontWeight="SemiBold" FontSize="13" TextTrimming="CharacterEllipsis"/>
                                        <TextBlock Text="Model File" Foreground="{StaticResource TextSecondary}" FontSize="11" Margin="0,2,0,0"/>
                                    </StackPanel>

                                    <ToggleButton Grid.Column="1" IsChecked="{Binding AreAllPartsVisible, Mode=TwoWay}" Style="{StaticResource TransparentIconToggleButton}" Width="32" Height="32" Margin="0,0,4,0" ToolTip="Toggle Visibility">
                                        <materialIcons:MaterialIcon Width="16" Height="16">
                                            <materialIcons:MaterialIcon.Style>
                                                <Style TargetType="materialIcons:MaterialIcon">
                                                    <Setter Property="Kind" Value="Eye" />
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding IsChecked, RelativeSource={RelativeSource AncestorType=ToggleButton}}" Value="False">
                                                            <Setter Property="Kind" Value="EyeOff" />
                                                            <Setter Property="Foreground" Value="{StaticResource TextMuted}"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </materialIcons:MaterialIcon.Style>
                                        </materialIcons:MaterialIcon>
                                    </ToggleButton>
                                    
                                    <Button Grid.Column="2" x:Name="DeleteModelButton" Click="DeleteModelButton_Click" Tag="{Binding}" Style="{StaticResource TransparentIconButton}" Width="32" Height="32" ToolTip="Remove Model">
                                        <materialIcons:MaterialIcon Kind="TrashCanOutline" Width="16" Foreground="{StaticResource AccentRed}"/>
                                    </Button>
                                </Grid>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>
                </Grid>

                <!-- STUDIO (New Panel) -->
                <ScrollViewer x:Name="StudioPanel" VerticalScrollBarVisibility="Auto">
                    <ScrollViewer.Style>
                        <Style TargetType="ScrollViewer">
                            <Setter Property="Visibility" Value="Collapsed"/>
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding IsChecked, ElementName=TabStudio}" Value="True">
                                    <Setter Property="Visibility" Value="Visible"/>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </ScrollViewer.Style>
                    <StackPanel Margin="0,0,0,32">
                        <!-- ENVIRONMENT -->
                        <GroupBox Header="Environment" Style="{StaticResource SettingsGroupBoxStyle}" Margin="0,0,0,6">
                            <GroupBox.HeaderTemplate>
                                <DataTemplate>
                                    <Grid>
                                        <StackPanel>
                                            <TextBlock Text="Environment" FontWeight="Bold" FontSize="13" Foreground="{StaticResource TextPrimary}"/>
                                            <TextBlock Text="Visual style and background." FontSize="10" Foreground="{StaticResource TextMuted}" Margin="0,2,0,0"/>
                                        </StackPanel>
                                    </Grid>
                                </DataTemplate>
                            </GroupBox.HeaderTemplate>
                            <UniformGrid Columns="2" Margin="0,4">
                                <!-- Skybox Toggle -->
                                <ToggleButton x:Name="ShowSkyboxCheck" 
                                              Style="{StaticResource ModernTileToggleButton}" 
                                              IsChecked="True" 
                                              Checked="EnvironmentCheck_Changed" 
                                              Unchecked="EnvironmentCheck_Changed"
                                              Margin="0,0,4,0"
                                              ToolTip="Show the 3D Skybox environment">
                                    <StackPanel>
                                        <materialIcons:MaterialIcon Kind="Earth" Width="24" Height="24" Margin="0,0,0,4" HorizontalAlignment="Center"/>
                                        <TextBlock Text="Skybox" FontSize="11" FontWeight="SemiBold" HorizontalAlignment="Center"/>
                                    </StackPanel>
                                </ToggleButton>

                                <!-- Transparent Toggle -->
                                <ToggleButton x:Name="TransparentBgCheck" 
                                              Style="{StaticResource ModernTileToggleButton}" 
                                              Checked="EnvironmentCheck_Changed" 
                                              Unchecked="EnvironmentCheck_Changed"
                                              Margin="4,0,0,0"
                                              ToolTip="Remove background for transparency">
                                    <StackPanel>
                                        <materialIcons:MaterialIcon Kind="ImageOff" Width="24" Height="24" Margin="0,0,0,4" HorizontalAlignment="Center"/>
                                        <TextBlock Text="No Background" FontSize="11" FontWeight="SemiBold" HorizontalAlignment="Center"/>
                                    </StackPanel>
                                </ToggleButton>
                            </UniformGrid>
                        </GroupBox>

                        <!-- CAMERA -->
                        <GroupBox Header="Camera Lens" Style="{StaticResource SettingsGroupBoxStyle}" Margin="0,0,0,6">
                            <GroupBox.HeaderTemplate>
                                <DataTemplate>
                                    <Grid>
                                        <StackPanel>
                                            <TextBlock Text="Camera Lens" FontWeight="Bold" FontSize="13" Foreground="{StaticResource TextPrimary}"/>
                                            <TextBlock Text="FOV and perspective controls." FontSize="10" Foreground="{StaticResource TextMuted}" Margin="0,2,0,0"/>
                                        </StackPanel>
                                    </Grid>
                                </DataTemplate>
                            </GroupBox.HeaderTemplate>
                            <StackPanel>
                                <Grid Margin="0,6">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="40"/>
                                    </Grid.ColumnDefinitions>
                                    <materialIcons:MaterialIcon Kind="FocusAuto" Width="16" Foreground="{StaticResource AccentBlue}" Margin="0,0,10,0" ToolTip="Field of View (FOV)"/>
                                    <Slider Grid.Column="1" x:Name="FovSlider" Minimum="10" Maximum="120" Value="45" ValueChanged="FovSlider_ValueChanged" VerticalAlignment="Center"/>
                                    <TextBlock Grid.Column="2" Text="{Binding ElementName=FovSlider, Path=Value, StringFormat={}{0:F0}}" FontSize="11" Foreground="{StaticResource TextMuted}" VerticalAlignment="Center" HorizontalAlignment="Center"/>
                                </Grid>
                            </StackPanel>
                        </GroupBox>

                        <!-- LIGHTING -->
                        <GroupBox Header="Studio Lighting" Style="{StaticResource SettingsGroupBoxStyle}" Margin="0,0,0,6">
                            <GroupBox.HeaderTemplate>
                                <DataTemplate>
                                    <Grid>
                                        <StackPanel>
                                            <TextBlock Text="Studio Lighting" FontWeight="Bold" FontSize="13" Foreground="{StaticResource TextPrimary}"/>
                                            <TextBlock Text="Sun rotation and altitude." FontSize="10" Foreground="{StaticResource TextMuted}" Margin="0,2,0,0"/>
                                        </StackPanel>
                                    </Grid>
                                </DataTemplate>
                            </GroupBox.HeaderTemplate>
                            <StackPanel>
                                <Grid Margin="0,6">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="40"/>
                                    </Grid.ColumnDefinitions>
                                    <materialIcons:MaterialIcon Kind="LightbulbOnOutline" Width="16" Foreground="{StaticResource AccentBrush}" Margin="0,0,10,0" ToolTip="Ambient Intensity (Base Light)"/>
                                    <Slider Grid.Column="1" x:Name="AmbientIntensitySlider" Minimum="0" Maximum="100" Value="100" ValueChanged="LightSlider_ValueChanged" VerticalAlignment="Center"/>
                                    <TextBlock Grid.Column="2" Text="{Binding ElementName=AmbientIntensitySlider, Path=Value, StringFormat={}{0:F0}%}" FontSize="11" Foreground="{StaticResource TextMuted}" VerticalAlignment="Center" HorizontalAlignment="Center"/>
                                </Grid>
                                <Grid Margin="0,6">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="40"/>
                                    </Grid.ColumnDefinitions>
                                    <materialIcons:MaterialIcon Kind="Orbit" Width="16" Foreground="{StaticResource AccentOrange}" Margin="0,0,10,0" ToolTip="Rotation"/>
                                    <Slider Grid.Column="1" x:Name="LightRotationSlider" Minimum="0" Maximum="360" Value="0" ValueChanged="LightSlider_ValueChanged" VerticalAlignment="Center"/>
                                    <TextBlock Grid.Column="2" Text="{Binding ElementName=LightRotationSlider, Path=Value, StringFormat={}{0:F0}}" FontSize="11" Foreground="{StaticResource TextMuted}" VerticalAlignment="Center" HorizontalAlignment="Center"/>
                                </Grid>
                                <Grid Margin="0,6">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="40"/>
                                    </Grid.ColumnDefinitions>
                                    <materialIcons:MaterialIcon Kind="ArrowUpBold" Width="16" Foreground="{StaticResource AccentYellow}" Margin="0,0,10,0" ToolTip="Altitude"/>
                                    <Slider Grid.Column="1" x:Name="LightHeightSlider" Minimum="0" Maximum="90" Value="0" ValueChanged="LightSlider_ValueChanged" VerticalAlignment="Center"/>
                                    <TextBlock Grid.Column="2" Text="{Binding ElementName=LightHeightSlider, Path=Value, StringFormat={}{0:F0}}" FontSize="11" Foreground="{StaticResource TextMuted}" VerticalAlignment="Center" HorizontalAlignment="Center"/>
                                </Grid>
                            </StackPanel>
                        </GroupBox>

                        <!-- RENDER ACTIONS -->
                        <StackPanel Margin="0,4,0,0">
                            <Button x:Name="SnapshotButton" Click="SnapshotButton_Click" Style="{StaticResource ModernButton}" Height="36">
                                <StackPanel Orientation="Horizontal">
                                    <materialIcons:MaterialIcon Kind="Camera" Width="16" Height="16" Margin="0,0,8,0"/>
                                    <TextBlock Text="Take 4K Snapshot" VerticalAlignment="Center"/>
                                </StackPanel>
                            </Button>
                            
                            <Button Click="ResetStudio_Click" Style="{StaticResource SecondaryButton}" Margin="0,6,0,0" Height="36">
                                <StackPanel Orientation="Horizontal">
                                    <materialIcons:MaterialIcon Kind="Refresh" Width="16" Height="16" Margin="0,0,8,0"/>
                                    <TextBlock Text="Reset Studio Settings" FontSize="11" VerticalAlignment="Center"/>
                                </StackPanel>
                            </Button>
                        </StackPanel>
                    </StackPanel>
                </ScrollViewer>

                <!-- MESHES -->
                <Grid x:Name="MeshesPanel">
                    <Grid.Style>
                        <Style TargetType="Grid">
                            <Setter Property="Visibility" Value="Collapsed"/>
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding IsChecked, ElementName=TabMeshes}" Value="True">
                                    <Setter Property="Visibility" Value="Visible"/>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </Grid.Style>
                    <ScrollViewer VerticalScrollBarVisibility="Auto">
                        <ItemsControl x:Name="MeshesItemsControl">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Border Background="{StaticResource CardBackground}" CornerRadius="8" BorderBrush="{StaticResource BorderColor}" BorderThickness="1" Margin="0,0,0,6" Padding="10,8">
                                        <StackPanel>
                                            <!-- Row 1: Visibility & Name -->
                                            <Grid Margin="0,0,0,8">
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="Auto"/>
                                                    <ColumnDefinition Width="*"/>
                                                </Grid.ColumnDefinitions>
                                                <CheckBox Style="{StaticResource ModernCheckBox}" IsChecked="{Binding IsVisible, Mode=TwoWay}" VerticalAlignment="Center" Margin="0,0,10,0"/>
                                                <TextBlock Grid.Column="1" Text="{Binding Name}" FontWeight="SemiBold" FontSize="12" Foreground="{StaticResource TextPrimary}" VerticalAlignment="Center" TextTrimming="CharacterEllipsis"/>
                                            </Grid>

                                            <!-- Row 2: Texture Selector (Compact & Visual) -->
                                            <Grid>
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="Auto"/>
                                                    <ColumnDefinition Width="*"/>
                                                </Grid.ColumnDefinitions>
                                                
                                                <!-- Icon Indicator -->
                                                <Border Grid.Column="0" Background="{StaticResource HoverColor}" CornerRadius="4" Width="28" Height="28" Margin="0,0,8,0" VerticalAlignment="Center" ToolTip="Active Texture">
                                                     <materialIcons:MaterialIcon Kind="TextureBox" Width="14" Height="14" Foreground="{StaticResource AccentPurple}" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                                </Border>

                                                <!-- Combo -->
                                                <ComboBox Grid.Column="1" 
                                                          Style="{StaticResource ModernComboBox}" 
                                                          Height="28" 
                                                          FontSize="11" 
                                                          ItemsSource="{Binding AvailableTextureNames}" 
                                                          SelectedItem="{Binding SelectedTextureName}"
                                                          VerticalAlignment="Center"/>
                                            </Grid>
                                        </StackPanel>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </ScrollViewer>
                </Grid>

                <!-- TRANSFORM -->
                <ScrollViewer x:Name="TransformPanel" VerticalScrollBarVisibility="Auto">
                    <ScrollViewer.Style>
                        <Style TargetType="ScrollViewer">
                            <Setter Property="Visibility" Value="Collapsed"/>
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding IsChecked, ElementName=TabTransform}" Value="True">
                                    <Setter Property="Visibility" Value="Visible"/>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </ScrollViewer.Style>
                    <StackPanel>
                        <!-- POSITION -->
                        <GroupBox Header="Position" Style="{StaticResource SettingsGroupBoxStyle}" Margin="0,0,0,6">
                            <GroupBox.HeaderTemplate>
                                <DataTemplate>
                                    <Grid>
                                        <TextBlock Text="Position" FontWeight="Bold" FontSize="13" Foreground="{StaticResource TextPrimary}"/>
                                        <Button HorizontalAlignment="Right" Click="ResetPosition_Click" Style="{StaticResource TransparentIconButton}" Width="28" Height="28" ToolTip="Reset Position">
                                            <materialIcons:MaterialIcon Kind="Refresh" Width="16"/>
                                        </Button>
                                    </Grid>
                                </DataTemplate>
                            </GroupBox.HeaderTemplate>
                            <StackPanel>
                                <Grid Margin="0,6">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="50"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <materialIcons:MaterialIcon Kind="ArrowRight" Width="16" Foreground="{StaticResource AccentOrange}" Margin="0,0,10,0"/>
                                    <Slider Grid.Column="1" x:Name="PositionXSlider" Minimum="-1000" Maximum="1000" ValueChanged="TransformSlider_ValueChanged" VerticalAlignment="Center"/>
                                    <TextBlock Grid.Column="2" Text="{Binding ElementName=PositionXSlider, Path=Value, StringFormat={}{0:F0}}" FontSize="11" Foreground="{StaticResource TextMuted}" VerticalAlignment="Center" HorizontalAlignment="Center"/>
                                    <ToggleButton Grid.Column="3" x:Name="PositionXLock" Style="{StaticResource TransparentIconToggleButton}" Width="28">
                                        <materialIcons:MaterialIcon Kind="LockOpenVariant" Width="14"/>
                                    </ToggleButton>
                                </Grid>
                                <Grid Margin="0,6">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="50"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <materialIcons:MaterialIcon Kind="ArrowUp" Width="16" Foreground="{StaticResource AccentGreen}" Margin="0,0,10,0"/>
                                    <Slider Grid.Column="1" x:Name="PositionYSlider" Minimum="-1000" Maximum="3000" ValueChanged="TransformSlider_ValueChanged" VerticalAlignment="Center"/>
                                    <TextBlock Grid.Column="2" Text="{Binding ElementName=PositionYSlider, Path=Value, StringFormat={}{0:F0}}" FontSize="11" Foreground="{StaticResource TextMuted}" VerticalAlignment="Center" HorizontalAlignment="Center"/>
                                    <ToggleButton Grid.Column="3" x:Name="PositionYLock" Style="{StaticResource TransparentIconToggleButton}" Width="28">
                                        <materialIcons:MaterialIcon Kind="LockOpenVariant" Width="14"/>
                                    </ToggleButton>
                                </Grid>
                                <Grid Margin="0,6">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="50"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <materialIcons:MaterialIcon Kind="ArrowDown" Width="16" Foreground="{StaticResource AccentBlue}" Margin="0,0,10,0"/>
                                    <Slider Grid.Column="1" x:Name="PositionZSlider" Minimum="-1000" Maximum="1000" ValueChanged="TransformSlider_ValueChanged" VerticalAlignment="Center"/>
                                    <TextBlock Grid.Column="2" Text="{Binding ElementName=PositionZSlider, Path=Value, StringFormat={}{0:F0}}" FontSize="11" Foreground="{StaticResource TextMuted}" VerticalAlignment="Center" HorizontalAlignment="Center"/>
                                    <ToggleButton Grid.Column="3" x:Name="PositionZLock" Style="{StaticResource TransparentIconToggleButton}" Width="28">
                                        <materialIcons:MaterialIcon Kind="LockOpenVariant" Width="14"/>
                                    </ToggleButton>
                                </Grid>
                            </StackPanel>
                        </GroupBox>
                        
                        <!-- ROTATION -->
                        <GroupBox Header="Rotation" Style="{StaticResource SettingsGroupBoxStyle}" Margin="0,0,0,6">
                            <GroupBox.HeaderTemplate>
                                <DataTemplate>
                                    <Grid>
                                        <TextBlock Text="Rotation" FontWeight="Bold" FontSize="13" Foreground="{StaticResource TextPrimary}"/>
                                        <Button HorizontalAlignment="Right" Click="ResetRotation_Click" Style="{StaticResource TransparentIconButton}" Width="28" Height="28" ToolTip="Reset Rotation">
                                            <materialIcons:MaterialIcon Kind="Refresh" Width="16"/>
                                        </Button>
                                    </Grid>
                                </DataTemplate>
                            </GroupBox.HeaderTemplate>
                            <StackPanel>
                                <Grid Margin="0,6">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="50"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <materialIcons:MaterialIcon Kind="Rotate3d" Width="16" Foreground="{StaticResource AccentOrange}" Margin="0,0,10,0"/>
                                    <Slider Grid.Column="1" x:Name="RotationXSlider" Minimum="-360" Maximum="360" ValueChanged="TransformSlider_ValueChanged" VerticalAlignment="Center"/>
                                    <TextBlock Grid.Column="2" Text="{Binding ElementName=RotationXSlider, Path=Value, StringFormat={}{0:F0}}" FontSize="11" Foreground="{StaticResource TextMuted}" VerticalAlignment="Center" HorizontalAlignment="Center"/>
                                    <ToggleButton Grid.Column="3" x:Name="RotationXLock" Style="{StaticResource TransparentIconToggleButton}" Width="28">
                                        <materialIcons:MaterialIcon Kind="LockOpenVariant" Width="14"/>
                                    </ToggleButton>
                                </Grid>
                                <Grid Margin="0,6">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="50"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <materialIcons:MaterialIcon Kind="Rotate3d" Width="16" Foreground="{StaticResource AccentGreen}" Margin="0,0,10,0"/>
                                    <Slider Grid.Column="1" x:Name="RotationYSlider" Minimum="-360" Maximum="360" ValueChanged="TransformSlider_ValueChanged" VerticalAlignment="Center"/>
                                    <TextBlock Grid.Column="2" Text="{Binding ElementName=RotationYSlider, Path=Value, StringFormat={}{0:F0}}" FontSize="11" Foreground="{StaticResource TextMuted}" VerticalAlignment="Center" HorizontalAlignment="Center"/>
                                    <ToggleButton Grid.Column="3" x:Name="RotationYLock" Style="{StaticResource TransparentIconToggleButton}" Width="28">
                                        <materialIcons:MaterialIcon Kind="LockOpenVariant" Width="14"/>
                                    </ToggleButton>
                                </Grid>
                                <Grid Margin="0,6">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="50"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <materialIcons:MaterialIcon Kind="Rotate3d" Width="16" Foreground="{StaticResource AccentBlue}" Margin="0,0,10,0"/>
                                    <Slider Grid.Column="1" x:Name="RotationZSlider" Minimum="-360" Maximum="360" ValueChanged="TransformSlider_ValueChanged" VerticalAlignment="Center"/>
                                    <TextBlock Grid.Column="2" Text="{Binding ElementName=RotationZSlider, Path=Value, StringFormat={}{0:F0}}" FontSize="11" Foreground="{StaticResource TextMuted}" VerticalAlignment="Center" HorizontalAlignment="Center"/>
                                    <ToggleButton Grid.Column="3" x:Name="RotationZLock" Style="{StaticResource TransparentIconToggleButton}" Width="28">
                                        <materialIcons:MaterialIcon Kind="LockOpenVariant" Width="14"/>
                                    </ToggleButton>
                                </Grid>
                            </StackPanel>
                        </GroupBox>
                        
                        <!-- SCALE -->
                        <GroupBox Header="Scale" Style="{StaticResource SettingsGroupBoxStyle}" Margin="0,0,0,6">
                            <GroupBox.HeaderTemplate>
                                <DataTemplate>
                                    <Grid>
                                        <TextBlock Text="Scale" FontWeight="Bold" FontSize="13" Foreground="{StaticResource TextPrimary}"/>
                                        <Button HorizontalAlignment="Right" Click="ResetScale_Click" Style="{StaticResource TransparentIconButton}" Width="28" Height="28" ToolTip="Reset Scale">
                                            <materialIcons:MaterialIcon Kind="Refresh" Width="16"/>
                                        </Button>
                                    </Grid>
                                </DataTemplate>
                            </GroupBox.HeaderTemplate>
                            <Grid Margin="0,6">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="50"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                <materialIcons:MaterialIcon Kind="Resize" Width="16" Foreground="{StaticResource AccentPurple}" Margin="0,0,10,0"/>
                                <Slider Grid.Column="1" x:Name="ScaleSlider" Minimum="0.1" Maximum="5" Value="1" ValueChanged="TransformSlider_ValueChanged" VerticalAlignment="Center"/>
                                <TextBlock Grid.Column="2" Text="{Binding ElementName=ScaleSlider, Path=Value, StringFormat={}{0:F2}}" FontSize="11" Foreground="{StaticResource TextMuted}" VerticalAlignment="Center" HorizontalAlignment="Center"/>
                                <ToggleButton Grid.Column="3" x:Name="ScaleLock" Style="{StaticResource TransparentIconToggleButton}" Width="28">
                                    <materialIcons:MaterialIcon Kind="LockOpenVariant" Width="14"/>
                                </ToggleButton>
                            </Grid>
                        </GroupBox>
                    </StackPanel>
                </ScrollViewer>

                <!-- ANIMATIONS -->
                <Grid x:Name="AnimationsPanel">
                    <Grid.Style>
                        <Style TargetType="Grid">
                            <Setter Property="Visibility" Value="Collapsed"/>
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding IsChecked, ElementName=TabAnimations}" Value="True">
                                    <Setter Property="Visibility" Value="Visible"/>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </Grid.Style>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>
                    
                    <ListBox x:Name="AnimationsListBox" SelectionChanged="AnimationsListBox_SelectionChanged" Background="Transparent" BorderThickness="0" Style="{StaticResource SmoothScrollListBox}">
                        <ListBox.ItemContainerStyle>
                            <Style TargetType="ListBoxItem">
                                <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                                <Setter Property="Background" Value="Transparent"/>
                                <Setter Property="Padding" Value="0"/>
                                <Setter Property="Margin" Value="0,0,0,4"/>
                                <Setter Property="Template">
                                    <Setter.Value>
                                        <ControlTemplate TargetType="ListBoxItem">
                                            <Grid x:Name="RootGrid">
                                                <!-- 1. Background / Selection Border -->
                                                <Border x:Name="SelectionBorder" Background="{StaticResource CardBackground}" CornerRadius="8" BorderBrush="{StaticResource BorderColor}" BorderThickness="1"/>
                                                
                                                <!-- 2. Content -->
                                                <Grid Margin="12,8">
                                                    <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="*"/>
                                                        <ColumnDefinition Width="Auto"/>
                                                    </Grid.ColumnDefinitions>
                                                    <ContentPresenter Grid.Column="0" />
                                                    <materialIcons:MaterialIcon x:Name="CheckIcon" Grid.Column="1" Kind="CheckCircle" Foreground="{StaticResource AccentBrush}" Width="16" Height="16" Margin="8,0,0,0" Visibility="Collapsed"/>
                                                </Grid>
                                            </Grid>
                                            <ControlTemplate.Triggers>
                                                <Trigger Property="IsSelected" Value="True">
                                                    <Setter TargetName="SelectionBorder" Property="BorderBrush" Value="{StaticResource AccentBrush}"/>
                                                    <Setter TargetName="SelectionBorder" Property="BorderThickness" Value="1.5"/>
                                                    <Setter TargetName="SelectionBorder" Property="Background" Value="{StaticResource HoverColor}"/>
                                                    <Setter TargetName="CheckIcon" Property="Visibility" Value="Visible"/>
                                                </Trigger>
                                                <Trigger Property="IsMouseOver" Value="True">
                                                    <Setter TargetName="SelectionBorder" Property="Background" Value="{StaticResource HoverColor}"/>
                                                </Trigger>
                                            </ControlTemplate.Triggers>
                                        </ControlTemplate>
                                    </Setter.Value>
                                </Setter>
                            </Style>
                        </ListBox.ItemContainerStyle>
                        <ListBox.ItemTemplate>
                            <DataTemplate>
                                <TextBlock Text="{Binding Name}" Foreground="{StaticResource TextPrimary}" FontSize="12" VerticalAlignment="Center" TextTrimming="CharacterEllipsis"/>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>                
                    
                    <!-- Animation Controls -->
                    <Border Grid.Row="1" x:Name="AnimationControlsPanel" 
                            Background="{StaticResource CardBackground}" 
                            CornerRadius="12" Padding="12,10" Margin="0,8,0,8" 
                            BorderBrush="{StaticResource BorderColor}" BorderThickness="1" 
                            Visibility="{Binding SelectedItem, ElementName=AnimationsListBox, Converter={StaticResource NullToVisibilityConverter}}">
                        <StackPanel>
                            <Grid Margin="0,0,0,8">
                                <TextBlock Text="{Binding Name}" FontWeight="Bold" FontSize="12" Foreground="{StaticResource AccentBrush}" VerticalAlignment="Center" TextTrimming="CharacterEllipsis" MaxWidth="140" HorizontalAlignment="Left"/>
                                <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                                    <Button Click="PlayButton_Click" Style="{StaticResource IconButton}" Width="28" Height="28">
                                        <materialIcons:MaterialIcon Kind="Play" Width="16" Foreground="{StaticResource AccentGreen}"/>
                                    </Button>
                                    <ToggleButton Click="StopButton_Click" IsChecked="{Binding IsPlaying, Mode=OneWay}" Style="{StaticResource IconToggleButton}" Width="28" Height="28" Margin="4,0,0,0">
                                        <materialIcons:MaterialIcon Width="16">
                                            <materialIcons:MaterialIcon.Style>
                                                <Style TargetType="materialIcons:MaterialIcon">
                                                    <!-- Por defecto (Cuando está pausado -> Mostrar el Cuadrado para Resume) -->
                                                    <Setter Property="Kind" Value="Stop" />
                                                    <Setter Property="Foreground" Value="{StaticResource AccentRed}" />
                                                    <Style.Triggers>
                                                        <!-- Cuando está reproduciendo -> Mostrar Pausa -->
                                                        <DataTrigger Binding="{Binding IsPlaying}" Value="True">
                                                            <Setter Property="Kind" Value="Pause" />
                                                            <Setter Property="Foreground" Value="{StaticResource AccentRed}" />
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </materialIcons:MaterialIcon.Style>
                                        </materialIcons:MaterialIcon>
                                    </ToggleButton>
                                </StackPanel>
                            </Grid>
                            
                            <Slider Maximum="{Binding TotalDuration}" Value="{Binding CurrentTime, Mode=TwoWay}" Thumb.DragStarted="AnimationSlider_DragStarted" Thumb.DragCompleted="AnimationSlider_DragCompleted" ValueChanged="AnimationSlider_ValueChanged" Height="20" Margin="0,0,0,8"/>
                            
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                <materialIcons:MaterialIcon Kind="Speedometer" Width="14" Foreground="{StaticResource TextMuted}" Margin="0,0,8,0" VerticalAlignment="Center"/>
                                <Slider Grid.Column="1" Minimum="0.1" Maximum="4.0" Value="{Binding Speed, Mode=TwoWay}" VerticalAlignment="Center" Height="20"/>
                                <TextBlock Grid.Column="2" Text="{Binding Speed, StringFormat={}{0:F1}x}" FontSize="11" FontWeight="SemiBold" Foreground="{StaticResource TextPrimary}" Margin="8,0,0,0" VerticalAlignment="Center"/>
                            </Grid>
                        </StackPanel>
                    </Border>
                </Grid>
            </Grid>

            <!-- BOTTOM ACTIONS -->
            <Border Grid.Row="2" Background="{StaticResource CardBackground}" BorderBrush="{StaticResource BorderColor}" BorderThickness="0,1,0,0" Padding="16">
                <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                    <Button x:Name="LoadModelButton" Click="LoadModelButton_Click" Style="{StaticResource SecondaryButton}" Height="56" Width="80" Margin="0,0,6,0" Padding="0">
                        <StackPanel VerticalAlignment="Center">
                            <materialIcons:MaterialIcon x:Name="LoadModelIcon" Kind="CubeOutline" Width="20" Height="20" Foreground="{StaticResource AccentBrush}"/>
                            <TextBlock x:Name="LoadModelText" Text="Model" FontSize="11" FontWeight="SemiBold" Margin="0,6,0,0" HorizontalAlignment="Center"/>
                        </StackPanel>
                    </Button>
                    <Button x:Name="LoadChromaModelButton" Click="LoadChromaModelButton_Click" Style="{StaticResource SecondaryButton}" Height="56" Width="80" Margin="3,0,3,0" Padding="0">
                        <StackPanel VerticalAlignment="Center">
                            <materialIcons:MaterialIcon x:Name="LoadChromaModelIcon" Kind="Palette" Width="20" Height="20" Foreground="{StaticResource AccentPurple}"/>
                            <TextBlock Text="Chroma" FontSize="11" FontWeight="SemiBold" Margin="0,6,0,0" HorizontalAlignment="Center"/>
                        </StackPanel>
                    </Button>
                    <Button x:Name="LoadAnimationButton" Click="LoadAnimationButton_Click" Style="{StaticResource SecondaryButton}" Height="56" Width="80" Margin="6,0,0,0" Padding="0">
                        <StackPanel VerticalAlignment="Center">
                            <materialIcons:MaterialIcon Kind="AnimationPlay" Width="20" Height="20" Foreground="{StaticResource AccentGreen}"/>
                            <TextBlock Text="Anims" FontSize="11" FontWeight="SemiBold" Margin="0,6,0,0" HorizontalAlignment="Center"/>
                        </StackPanel>
                    </Button>
                </StackPanel>
            </Border>
            
            <!-- Hidden controls needed for logic -->
            <TextBlock x:Name="LoadModelTextHidden" Visibility="Collapsed"/><Button x:Name="PlayButtonHidden" Visibility="Collapsed"/>
        </Grid>
    </Border>
</UserControl>